电脑通过交换机连接多台 FPGA 。通过 UDP  通信。

### UDP 封装

封装多个头部信息以及参数，进行基本命令的传输。

#### 命令封装

UDP 封装包含 2 个字节 padding，12 字节传输层头部信息，8字节命令头部信息，和可变数目的参数。

##### 以太网帧头

- 包含 6 字节目标 MAC 地址，6 字节源 MAC 地址，2 字节以太网类型。因此以太网帧头一共包含 **14 个字节**。以太网尾部包含 4 字节冗余校验。
- 以太网类型： 0x0800 IPv4 数据报；0x86DD IPv6 帧；0x0806 ARP 帧；0x8100 IEEE 802.1Q 帧。

[Wiki-Link](https://zh.wikipedia.org/wiki/%E4%BB%A5%E5%A4%AA%E7%BD%91%E5%B8%A7%E6%A0%BC%E5%BC%8F)

##### IPv4 首部

> IPv4 是一种无连接的协议。会尽最大努力交付数据报，但不保证均能送达目的地，也不保证按序无重复到达。

- 首部包含 14 个字段，前 13 个是必须的，第 14 个是可选的。首部字段均以大端序包装。
- 前 32 bit ：
  - 4 bit 版本，IPv4->4；
  - 4 bit 首部长度，有多少32位字（4字节）。最小为 5 ，最大 15 。
  - 8 bit 区分服务，VoIP；
  - 16 bit 总长度，包含首部和数据，单位为字节，取值范围 20~65535，当大于数据链路层的最大传输单元时，报文需要被分片。
- 第二个 32 bit：
  - 16 bit 标识符，用来唯一标识一个报文的所有分片，没产生一个数据报，计数器加 1，并赋值给此字段。
  - 3 bit 标志，用于控制和识别分片，位 0：保留，必须为 0，位 1：禁止分片（DF），DF=0 时才允许分片，位 2：更多分片（MF），MF=1 表示后面还有分片，MF=0 表示最后一个分片。
  - 13 bit 分片偏移，指明了相对报文开头的偏移量，以 8 字节为单位。
- 第三个 32 bit：
  - 8 bit 存活时间，以秒为单位，实际上用于跳数计数器，经过路由器减 1 ，等于 0 时被丢弃。
  - 8 bit 协议，指明数据区采用的协议，如 ICMP-1/TCP-6/UDP-17 等。
  - 16 bit 首部校验和，若错误则丢弃。
- 第四个 32 bit：源地址。
- 第五个 32 bit：目的地址。
- 可选：1~40 字节不等，需要以 32 位填充。

[Wiki-Link](https://zh.wikipedia.org/wiki/IPv4)

##### UDP 首部

- 包括 4 个字段，每个字段占用 2 个字节。包含源端口，目的端口，报文长度，校验和。报文长度包括首部长度，校验和为 UDP 首部和数据的校验和。
- 应用：域名系统（DNS），简单网络管理协议（SNMP），动态主机配置协议（DHCP），路由信息协议（RIP）。

[Wiki-Link](https://zh.wikipedia.org/wiki/%E7%94%A8%E6%88%B7%E6%95%B0%E6%8D%AE%E6%8A%A5%E5%8D%8F%E8%AE%AE)

##### TCP 首部

> 应用层向 TCP 层发送数据流，然后 TCP 把数据流分成适当长度的报文段。数据在 TCP 层称为 stream，数据分组称为分段 segment。

- 首部包含 10 个必选字段和一个可选字段。10个必选字段占 20 个字节。
- 前 32 bit ：2 个字节源端口，2 个字节目的端口；
- 第二个 32 bit ：序列号；
- 第三个 32 bit ：确认号，期望收到的数据的开始序列号，即已经收到的数据的字节长度加 1 。
- 第四个 32 bit ：
  - 4 bit 数据偏移，以 4 字节为单位计算出的数据段开始地址的偏移值。 
  - 3 bit 保留，置 0
  - 9 bit 9 个标识符：NS，CWR，ECE，UGR，ACK，PSH，RST，SYN，FIN。
    - RST，为 1 表示出现严重差错 ，需要重新创建 TCP 连接。还可以用于拒绝非法报文段和拒绝连接请求
    - SYN，为 1 表示连接请求或连接接收请求，用于创建连接和使序号同步
    - FIN，为 1 表示发送方没有数据要传输了，要求释放连接。
  - 16 bit 窗口，表示从确认号开始，本报文的接受方可以接收的字节数，即接收窗口大小。用于流量控制。 
- 第五个 32 bit ：
  - 16 bit 校验和，包括 TCP 头部和数据
  - 16 bit 紧急指针，本报文段中的紧急数据的最后一个字节的序号 
- 可选字段，最多 40 字节。
  - 在创建连接设置 SYN 标志的数据包中指明最大报文段长度 MSS = MTU - 40 ，从而避免发生 IP 分片。

[Wiki-Link](https://zh.wikipedia.org/wiki/%E4%BC%A0%E8%BE%93%E6%8E%A7%E5%88%B6%E5%8D%8F%E8%AE%AE)

##### 封装

- 32 bit 对齐
  - 以太网头部信息占 14 字节，添加两个字节，使以太网，IP 头部和 UDP 头部 4 字节对齐。

- 封装传输层头部
  - 包含目标节点 ID，源节点 ID，包类型，长度，序列号，标志位。共 12 字节
- 封装命令头部
  - 命令 ID，命令参数的字节数，命令参数个数。共 8 字节。这部分与命令参数都是作为载荷。
- 命令参数
  - 每个参数占 32 bit 。
- 通过封装避免类使用者循环等待返回结果，如通过发送命令请求 BSS 信息，封装了超时重传功能。通过对比传输层头部的 ID 和序列号信息来判断是否是期望的回复。

### 包/帧/数据报/段/消息

1. 包（packet）：包可以说是全能的术语，是个泛指的概念；
2. 帧（frame）：帧特指数据链路层上包的单位，由帧头，有效载荷，帧尾组成；
3. 数据报（datagram）：数据报是 IP 和 UDP 等网络层以上的分层中包的单位，在网络层上的无连接网络中传输单元的概念
4. 段（segment）：表示 TCP 数据流中的信息
5. 消息（message）：指应用协议中数据的单位

